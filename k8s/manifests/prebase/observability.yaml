---
apiVersion: v1
kind: Namespace
metadata:
  name: observability
  labels:
    gateway.infra.services/allow-routes: "true"
    prometheus.io/scrape: "true"
    pod-security.kubernetes.io/enforce: privileged
    pod-security.kubernetes.io/audit: privileged
    pod-security.kubernetes.io/warn: privileged
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: kube-prometheus
  namespace: observability
spec:
  interval: 10m0s
  url: https://prometheus-community.github.io/helm-charts
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kube-prometheus
  namespace: observability
spec:
  install:
    crds: CreateReplace
  upgrade:
    crds: CreateReplace
  interval: 10m0s
  targetNamespace: observability
  chart:
    spec:
      chart: kube-prometheus-stack
      sourceRef:
        kind: HelmRepository
        name: kube-prometheus
      version: "81.6.7"
  valuesFrom:
    - kind: ConfigMap
      name: flux-kube-state-metrics-config
      valuesKey: kube-state-metrics-config.yaml
  values:
    defaultRules:
      kubeProxy: false
    kubeProxy:
      enabled: false
    kubeEtcd:
      service:
        selector:
          # Note this is just to get the endpoint IP
          # it's just Pods running with hostNetwork on the same nodes that
          # etcd runs on
          app.kubernetes.io/name: kube-apiserver
    nodeExporter:
      operatingSystems:
        aix:
          enabled: false
        darwin:
          enabled: false
    grafana:
      enabled: true
      sidecar:
        # Not really worth running the process just for live updates
        dashboards:
          watchMethod: LIST
          initDashboards: true
          skipReload: true
        datasources:
          watchMethod: LIST
          initDatasources: true
          skipReload: true
      route:
        main:
          enabled: true
          labels:
            external-dns: "true"
          hostnames:
            - grafana.${services_hostname_suffix}
          parentRefs:
            - name: services
              namespace: infra
              sectionName: main
      grafana.ini:
        server:
          root_url: https://grafana.${services_hostname_suffix}
        auth.generic_oauth:
          enabled: true
          auth_url: https://${cluster_oidc_issuer_host}/authorize
          token_url: https://${cluster_oidc_issuer_host}/api/oidc/token
          api_url: https://${cluster_oidc_issuer_host}/api/oidc/userinfo
          auto_login: true
          client_id: "$__file{/var/run/secrets/client_id}"
          client_secret: "$__file{/var/run/secrets/client_secret}"
          use_pkce: true
          scopes: openid profile email groups
          use_refresh_token: true
          login_attribute_path: preferred_username
          role_attribute_path: contains(groups[*], 'admins') && 'GrafanaAdmin' || 'Viewer'
          allow_assign_grafana_admin: true
      extraSecretMounts:
        - name: prometheus-oauth
          secretName: prometheus-oauth
          defaultMode: 0440
          mountPath: /var/run/secrets
          readOnly: true
    alertmanager:
      enabled: true
      alertmanagerSpec:
        secrets:
          - telegram-bot
          - watchdog-webhook
      config:
        route:
          routes:
            - receiver: watchdog-webhook
              matchers:
                - alertname = "Watchdog"
              group_wait: 0s
              group_interval: 30s
              repeat_interval: 30s
            - receiver: telegram
              matchers:
                - severity =~ "warning|critical"
        receivers:
          - name: "null"
          - name: telegram
            telegram_configs:
              - bot_token_file: /etc/alertmanager/secrets/telegram-bot/token
                chat_id: 1771190175
          - name: watchdog-webhook
            webhook_configs:
              - url_file: /etc/alertmanager/secrets/watchdog-webhook/url
      route:
        main:
          enabled: true
          labels:
            external-dns: "true"
          hostnames:
            - alertmanager.${services_hostname_suffix}
          parentRefs:
            - name: services
              namespace: infra
              sectionName: main
      templateFiles:
        telegram.tmpl: |-
          {{ define "telegram.default.message" }}
          {{- range .Alerts -}}
          {{- if eq .Status "firing" -}}
              {{- if eq .Labels.severity "critical" -}}
                  üö®
              {{- else if eq .Labels.severity "warning" -}}
                  ‚ö†
              {{- else -}}
                  ‚Ñπ
              {{- end }} <strong>{{ .Labels.alertname }}</strong>
          {{- else if eq .Status "resolved" -}}
              ‚úÖ <strong>{{ .Labels.alertname }}</strong> {{ if eq .Labels.severity "critical" -}}
                  üö®
              {{- else if eq .Labels.severity "warning" -}}
                  ‚ö†
              {{- else -}}
                  ‚Ñπ
              {{- end }}
          {{- end }}
          <a href="{{ .GeneratorURL }}">‚û°{{ .Annotations.description }}</a>
          {{- if eq .Status "firing" }}
          üïê from {{ .StartsAt | date "Mon, 02 Jan 2006 15:04:05 MST" }}
          üïê for {{ .StartsAt | since | humanizeDuration }}
          {{- end -}}
          {{- if eq .Status "resolved" }}
          üïê from {{ .StartsAt | date "Mon, 02 Jan 2006 15:04:05 MST" }}
          üïê until {{ .EndsAt | date "Mon, 02 Jan 2006 15:04:05 MST" }}
          üïê for {{ .EndsAt.Sub .StartsAt | humanizeDuration }}
          {{- end -}}
          {{- if .Annotations.runbook_url }}
          <a href="{{ .Annotations.runbook_url }}">üìñ docs</a>
          {{- end }}
          {{ end }}
          {{ end }}

    prometheusOperator:
      kubeletEndpointsEnabled: false
      kubeletEndpointSliceEnabled: true
    prometheus:
      enabled: true
      route:
        main:
          enabled: true
          labels:
            external-dns: "true"
          hostnames:
            - prometheus.${services_hostname_suffix}
          parentRefs:
            - name: services
              namespace: infra
              sectionName: main
      prometheusSpec:
        externalUrl: https://prometheus.${services_hostname_suffix}
        ruleSelectorNilUsesHelmValues: false
        serviceDiscoveryRole: EndpointSlice
        serviceMonitorSelectorNilUsesHelmValues: false
        serviceMonitorNamespaceSelector:
          matchLabels:
            prometheus.io/scrape: "true"
        scrapeClasses:
          - default: true
            name: cluster-relabeling
            relabelings:
              - sourceLabels: [ __name__ ]
                regex: (.*)
                targetLabel: cluster
                replacement: k8rn
                action: replace
